<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Création utilisateur avec QR Code</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* === Styles Base === */
        :root {
            --primary: #0D9488; --primary-light: #5EEAD4; --primary-dark: #0F766E;
            --secondary: #22D3EE; --accent: #A78BFA; --dark: #1E293B; --light: #F8FAFC;
            --gray: #64748B; --light-gray: #e2e8f0;
            --card-bg: rgba(255, 255, 255, 0.95);
            --navbar-bg: rgba(162, 217, 206, 0.3); --navbar-hover-bg: rgba(162, 217, 206, 0.4);
            --navbar-border: rgba(255, 255, 255, 0.2);
            --navbar-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3), 0 4px 20px rgba(13, 148, 136, 0.05);
            --navbar-hover-shadow: inset 0 0 15px rgba(255, 255, 255, 0.4), 0 6px 25px rgba(13, 148, 136, 0.1);
            --card-border: rgba(13, 148, 136, 0.15); --card-hover-border: rgba(13, 148, 136, 0.4);
            --card-shadow: 0 6px 15px rgba(190, 190, 190, 0.15), inset 0 1px 1px rgba(255, 255, 255, 0.3), inset 0 -1px 1px rgba(0, 0, 0, 0.02);
            --card-hover-shadow: 0 12px 28px rgba(13, 148, 136, 0.2), inset 0 1px 1px rgba(255, 255, 255, 0.4), inset 0 -1px 1px rgba(0, 0, 0, 0.03);
            --sans: 'Hellix', 'Arial', sans-serif;
            --color-events: #0D9488; --color-users: #F59E0B; --color-stats: #FF69B4; --color-admin: #A78BFA; --color-secondary: #64748B;
        }
        body { font-family: var(--sans); background-color: #F1F5F9; color: var(--dark); min-height: 100vh; margin: 0; padding-top: 90px; }

        /* --- Navbar & Links --- */
        .navbar { background: var(--navbar-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 0.4rem 1rem; box-shadow: var(--navbar-shadow); border: 1px solid var(--navbar-border); border-radius: 20px; position: fixed; width: 96%; left: 2%; top: 10px; z-index: 1030; display: flex; justify-content: space-between; align-items: center; transition: all 0.4s ease; }
        .navbar:hover { background: var(--navbar-hover-bg); box-shadow: var(--navbar-hover-shadow); transform: translateY(-2px); }
        .navbar-brand img { height: 20px; width: auto; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
        .navbar-brand1 img { height: 40px; width: auto; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
        .navbar-nav { display: flex; align-items: center; justify-content: center; flex-grow: 1; gap: 0.5rem; }
        .nav-link { color: var(--primary-dark) !important; font-size: 0.9rem; font-weight: 500; padding: 0.5rem 1rem; transition: color 0.25s ease, background-color 0.25s ease; display: flex; align-items: center; gap: 0.5rem; border-radius: 25px; background: transparent; border: 1px solid transparent; text-decoration: none !important; }
        .nav-link:hover { color: var(--primary-dark) !important; background: rgba(13, 148, 136, 0.08); }
        .nav-link.active {
            color: var(--light) !important;
            background: var(--navbar-bg) !important;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            font-weight: 600;
            box-shadow: none;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }
        .nav-link i { font-size: 1rem; }

        /* --- Dropdown --- */
        .dropdown-toggle::after { margin-left: 0.4rem; border-top-color: currentColor; transition: transform 0.3s ease; }
        .nav-item.show .dropdown-toggle::after, .nav-item.dropdown:hover .dropdown-toggle::after { transform: rotate(180deg); }
        .dropdown-menu { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--navbar-border); border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); padding: 0.75rem; margin-top: 0.6rem !important; }
        .dropdown-item-text strong { color: var(--dark); font-weight: 600; } .dropdown-item-text small { color: var(--gray); font-size: 0.8rem; display: block; margin-top: 2px; }
        .dropdown-divider { border-top: 1px solid rgba(0, 0, 0, 0.1); margin: 0.5rem 0; }
        .dropdown-item { font-size: 0.85rem; color: var(--primary-dark); font-weight: 500; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s ease; background: transparent; }
        .dropdown-item:hover { background: var(--primary); color: var(--light); transform: translateX(3px); box-shadow: none; }
        .navbar-right { margin-left: auto; }

        /* --- Contenu Principal & Titre Centré --- */
        .main-content { padding: 2rem; max-width: 1600px; margin: 0 auto; }
        .page-header { margin-bottom: 2rem; text-align: center; }
        .page-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--dark); font-family: var(--sans); }

        /* --- Bouton Ajouter Centré --- */
        .button-container { text-align: center; margin-bottom: 1.5rem; }
        .btn-custom-action { display: inline-flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 500; font-size: 0.9rem; padding: 0.6rem 1.2rem; border-radius: 25px; background: rgba(13, 148, 136, 0.08); border: 1px solid rgba(13, 148, 136, 0.1); transition: all 0.25s ease; text-decoration: none; cursor: pointer; }
        .btn-custom-action i { margin-right: 0.4rem; }
        .btn-custom-action:hover { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(13, 148, 136, 0.25); transform: scale(1.03); }

        /* --- Blocs de Contenu --- */
        .content-block { background: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid var(--card-border); padding: 1.75rem; margin-bottom: 1.5rem; overflow: hidden; }
        .content-block h2 { font-size: 1.3rem; font-weight: 600; color: var(--dark); margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--light-gray); }

        /* --- Conteneur pour le bouton Retirer et la recherche --- */
        .controls-container { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1rem; }
        .remove-btn-container { flex: 0 0 auto; }
        .search-container { flex: 0 0 auto; }
        #searchInput { width: 300px; }
        #removeSelectedBtn { display: none; }
        .btn-custom-danger { display: inline-flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: #EF4444; border-radius: 25px; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 500; transition: all 0.25s ease; border: 1px solid; }
        .btn-custom-danger i { margin-right: 0.4rem; }
        .btn-custom-danger:hover { background: #EF4444; color: white; border-color: #EF4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); transform: scale(1.03); }

        /* --- Tableau avec Scroll --- */
        .table-responsive-scrollable { max-height: 500px; overflow-y: auto; border: 1px solid var(--light-gray); border-radius: 8px; margin-top: 20px; }
        .table { margin-bottom: 0; border-collapse: separate; border-spacing: 0; }
        .table thead th { background: var(--navbar-bg) !important; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: var(--primary-dark) !important; font-weight: 600; text-align: center; padding: 0.8rem 1rem; vertical-align: middle; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid rgba(13, 148, 136, 0.2) !important; }
        .table thead th:first-child { border-top-left-radius: 7px; } .table thead th:last-child { border-top-right-radius: 7px; }
        .table tbody td { background-color: white; text-align: center; vertical-align: middle; padding: 0.75rem 1rem; font-size: 0.9rem; color: var(--dark); border-right: 1px solid var(--light-gray); border-bottom: 1px solid var(--light-gray); }
        .table tbody td:last-child { border-right: 0; } .table tbody tr:last-child td { border-bottom: 0; }
        .table-hover tbody tr:hover td { background-color: #f1f5f9; }
        .table tbody tr.selected td { background-color: #E2E8F0; }
        .badge-common { display: inline-block; font-size: 0.75rem; padding: 0.3em 0.7em; border-radius: 15px; min-width: 80px; text-align: center; font-weight: 600; letter-spacing: 0.5px; color: white; }
        .badge-status-success { background-color: var(--color-events); } .badge-status-danger { background-color: var(--color-stats); } .badge-status-warning { background-color: var(--color-users); }

        /* --- Nombre total d'utilisateurs centré --- */
        .users-count-container { text-align: center; margin-top: 1rem; }
        #eventUsersCount { display: inline-block; }

        /* --- Modals --- */
        .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); background-color: var(--light); }
        .modal-header { background-color: var(--primary); color: white; border-top-left-radius: 11px; border-top-right-radius: 11px; border-bottom: none; padding: 1rem 1.5rem; }
        .modal-header .btn-close { filter: brightness(0) invert(1); }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-body { padding: 1.5rem; } .modal-body p { margin-bottom: 0.8rem; font-size: 0.95rem; color: var(--gray); }
        .modal-body p strong { color: var(--dark); min-width: 120px; display: inline-block; }
        .modal-footer {
            border-top: 1px solid var(--light-gray);
            padding: 1rem 1.5rem,
            display: flex,
            justify-content: center,
            align-items: center,
            gap: 0.75rem,
            flex-wrap: wrap,
        }
        .modal-footer .btn { min-width: 100px; }
        .btn-custom-secondary { display: inline-flex; align-items: center; justify-content: center; background: rgba(100, 116, 139, 0.1); border-color: rgba(100, 116, 139, 0.2); color: var(--gray); border-radius: 25px; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 500; transition: all 0.25s ease; border: 1px solid; }
        .btn-custom-secondary:hover { background: var(--gray); color: white; border-color: var(--gray); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2); transform: scale(1.03); }

        /* --- SweetAlert --- */
        .swal2-popup { border-radius: 12px !important; font-family: var(--sans) !important; }
        .swal2-title { color: var(--dark) !important; font-weight: 600 !important; }
        .swal2-html-container { color: var(--gray) !important; }
        .swal2-confirm, .swal2-cancel { border-radius: 25px !important; padding: 0.6rem 1.5rem !important; font-weight: 500 !important; transition: all 0.25s ease !important; box-shadow: none !important; }
        .swal2-confirm { background-color: #EF4444 !important; border: 1px solid #EF4444 !important; color: white !important; }
        .swal2-confirm:hover { background-color: #dc2626 !important; border-color: #dc2626 !important; transform: scale(1.03); }
        .swal2-cancel { background-color: rgba(100, 116, 139, 0.1) !important; border: 1px solid rgba(100, 116, 139, 0.2) !important; color: var(--gray) !important; }
        .swal2-cancel:hover { background-color: var(--gray) !important; border-color: var(--gray) !important; color: white !important; transform: scale(1.03); }

        /* --- Styles spécifiques --- */
        .arrow { display: inline-block; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; margin-left: 5px; }
        .arrow.asc { border-bottom: 6px solid #000; }
        .arrow.desc { border-top: 6px solid #000; }
        .qr-code-container canvas { margin: 10px auto; display: block; }
        .modal-options-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .back-arrow { position: absolute; left: 10px; font-size: 20px; cursor: pointer; color: white; background: none; border: none; padding: 0; }
        .back-arrow:hover { color: #ddd; }

        /* --- Responsive --- */
        @media (max-width: 991.98px) {
            .navbar-nav { margin-top: 1rem; flex-direction: column; align-items: stretch; width: 100%; }
            .nav-item { width: 100%; } .nav-link { justify-content: flex-start; width: 100%; margin-bottom: 0.5rem; padding: 0.5rem 1rem; }
            .navbar-right { display: none; } .dropdown-menu { width: 95%; }
            #searchInput { width: 100%; max-width: none; }
            .controls-container { flex-direction: column; align-items: flex-start; }
            .search-container { width: 100%; display: flex; justify-content: flex-end; }
            #removeSelectedBtn { margin-bottom: 10px; }
        }
        @media (max-width: 767.98px) {
            body { padding-top: 80px; }
            .navbar { width: 94%; left: 3%; top: 10px; padding: 0.5rem 1rem; border-radius: 15px; }
            .main-content { padding: 1.5rem; }
            .content-block { padding: 1.25rem; border-radius: 12px; margin-bottom: 1rem; }
            .page-header h1 { font-size: 1.5rem; }
        }
		
		.subtitle-gray {
    color: var(--gray); /* #64748B */
}
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <a class="navbar-brand" href="/dashboard"><img src="/assets/evenvo.png" alt="Logo evenvo gauche"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-home"></i></a></li>
                <li class="nav-item"><a class="nav-link" href="/event/<%= eventId %>"><i class="far fa-calendar-alt"></i> Événement</a></li>
                <li class="nav-item"><a class="nav-link active" href="/event/<%= eventId %>/suivi_utilisateur"><i class="fas fa-users"></i> Participants</a></li>
                <li class="nav-item"><a class="nav-link" href="/event/<%= eventId %>/suivi_presence"><i class="fas fa-clipboard-check"></i> Présences</a></li>
                <li class="nav-item"><a class="nav-link" href="/event/<%= eventId %>/suivi_vote"><i class="fas fa-vote-yea"></i> Vote</a></li>
                <li class="nav-item"><a class="nav-link" href="/event/<%= eventId %>/gestion_event"><i class="fas fa-cog"></i> Gestion</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text"><strong id="userFullName">Chargement...</strong><br><small id="userEmail">...</small></span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt fa-fw me-2"></i>Déconnexion</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="navbar-right d-none d-lg-block"><a class="navbar-brand1" href="/dashboard"><img src="/assets/logo.png" alt="Logo droite"></a></div>
    </nav>

    <!-- Contenu Principal -->
    <div class="main-content">
        <div class="page-header">
            <h1>Participants de l'événement</h1>
			<p class="subtitle-gray">Événement : <%= eventName %></p>
        </div>

        <!-- Bouton Ajouter centré -->
        <div class="button-container">
            <button type="button" class="btn btn-custom-action" id="addUserBtn"><i class="fas fa-plus"></i> Ajouter des participants</button>
        </div>

        <!-- Table des participants -->
        <div class="content-block">
            <h2>Liste des Participants</h2>
            <div class="controls-container">
                <div class="remove-btn-container">
                    <button type="button" class="btn btn-custom-danger" id="removeSelectedBtn"><i class="fas fa-user-minus"></i> Retirer</button>
                </div>
                <div class="search-container">
                    <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par nom ou prénom...">
                </div>
            </div>
            <div class="table-responsive-scrollable">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" /></th>
                            <th data-column="id" data-sort="none">ID <span class="arrow"></span></th>
                            <th data-column="name" data-sort="none">Nom <span class="arrow"></span></th>
                            <th data-column="surname" data-sort="none">Prénom <span class="arrow"></span></th>
                            <th data-column="civility" data-sort="none">Civilité <span class="arrow"></span></th>
                            <th data-column="birthdate" data-sort="none">Date de naissance <span class="arrow"></span></th>
                            <th data-column="email" data-sort="none">Email <span class="arrow"></span></th>
                            <th data-column="role" data-sort="none">Rôle <span class="arrow"></span></th>
                            <th data-column="accessCode" data-sort="none">Code d'accès <span class="arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (users && users.length > 0) { %>
                            <% users.forEach(user => { %>
                                <tr class="user-row" data-id="<%= user.id %>" data-name="<%= user.name %>" data-surname="<%= user.surname %>" data-civility="<%= user.civility %>" data-birthdate="<%= user.birthdate %>" data-email="<%= user.email %>" data-role="<%= user.role %>" data-accessCode="<%= user.accessCode %>">
                                    <td><input type="checkbox" class="userCheckboxx" data-id="<%= user.id %>" /></td>
                                    <td><%= user.id %></td>
                                    <td><%= user.name %></td>
                                    <td><%= user.surname %></td>
                                    <td><%= user.civility %></td>
                                    <td><%= user.birthdate %></td>
                                    <td><%= user.email %></td>
                                    <td><%= user.role %></td>
                                    <td><%= user.accessCode || 'Non généré' %></td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">Aucun participant trouvé.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            <div class="users-count-container">
                <span id="eventUsersCount" class="form-control">Nombre total d'utilisateurs : <%= users.length || 0 %></span>
            </div>
        </div>
    </div>

    <!-- Modal Détails Participant -->
    <div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailModalLabel">Détails du Participant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Nom :</strong> <span id="modalName"></span></p>
                    <p><strong>Prénom :</strong> <span id="modalSurname"></span></p>
                    <p><strong>Civilité :</strong> <span id="modalCivility"></span></p>
                    <p><strong>Date de naissance :</strong> <span id="modalBirthdate"></span></p>
                    <p><strong>Email :</strong> <span id="modalEmail"></span></p>
                    <p><strong>Rôle :</strong> <span id="modalRole"></span></p>
                    <p><strong>Code d'accès :</strong> <span id="modalAccessCode"></span></p>
                    <div class="text-center mt-3">
                        <img id="modalQRCode" alt="QR Code" class="img-fluid" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour choisir entre participants et organisations -->
    <div class="modal fade" id="addOptionsModal" tabindex="-1" role="dialog" aria-labelledby="addOptionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addOptionsModalLabel">Ajouter à l'événement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="modal-options-buttons">
                        <button type="button" class="btn btn-custom-action" id="addUsersOptionBtn"><i class="fas fa-user-plus"></i> Ajouter des participants</button>
                        <button type="button" class="btn btn-custom-action" id="addOrgOptionBtn"><i class="fas fa-building"></i> Ajouter une organisation</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter des participants -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Ajouter des participants</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive-scrollable">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th data-column="id" data-sort="none">ID <span class="arrow"></span></th>
                                    <th data-column="name" data-sort="none">Nom <span class="arrow"></span></th>
                                    <th data-column="surname" data-sort="none">Prénom <span class="arrow"></span></th>
                                    <th data-column="email">Email</th>
                                    <th data-column="role" data-sort="none">Rôle <span class="arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <!-- Les participants seront insérés ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div><span id="totalUsersCount" class="form-control">Nombre total d'utilisateurs : 0</span></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-custom-action" id="saveUsersBtn"><i class="fas fa-save"></i> Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une organisation -->
    <div class="modal fade" id="addOrgModal" tabindex="-1" role="dialog" aria-labelledby="addOrgModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addOrgModalLabel">Ajouter une organisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive-scrollable">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Code</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="orgTableBody">
                                <!-- Les organisations seront insérées ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-custom-action" id="saveOrgUsersBtn"><i class="fas fa-save"></i> Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour afficher les participants d'une organisation -->
    <div class="modal fade" id="orgUsersModal" tabindex="-1" role="dialog" aria-labelledby="orgUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="back-arrow" id="backToOrgModalBtn" title="Retour">⇦</button>
                    <h5 class="modal-title" id="orgUsersModalLabel">Participants de l'organisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive-scrollable">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllOrgUsers"></th>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                </tr>
                            </thead>
                            <tbody id="orgUsersTableBody">
                                <!-- Les participants seront insérés ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-custom-action" id="addOrgUsersBtn"><i class="fas fa-plus"></i> Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        // Fonction pour récupérer les infos utilisateur
        async function fetchUserInfo() {
            console.log("fetchUserInfo: Début");
            try {
                const response = await fetch('/get_user_info');
                if (!response.ok) throw new Error(`Erreur HTTP fetchUserInfo: ${response.status}`);
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    throw new TypeError(`Réponse inattendue du serveur (pas JSON): ${text.substring(0, 100)}...`);
                }
                const user = await response.json();
                const fullName = `${user.name || ''} ${user.surname || ''}`.trim();
                const userFullNameEl = document.getElementById('userFullName');
                const userEmailEl = document.getElementById('userEmail');
                if (userFullNameEl) userFullNameEl.textContent = fullName || 'Utilisateur';
                if (userEmailEl) userEmailEl.textContent = user.email || 'Email non disponible';
                console.log("fetchUserInfo: Infos utilisateur chargées");
            } catch (error) {
                console.error('fetchUserInfo: Erreur:', error);
                const userFullNameEl = document.getElementById('userFullName');
                const userEmailEl = document.getElementById('userEmail');
                if (userFullNameEl) userFullNameEl.textContent = 'Erreur';
                if (userEmailEl) userEmailEl.textContent = 'Chargement impossible';
            }
        }

        // Fonction pour mettre à jour la visibilité du bouton "Retirer"
        function updateRemoveButtonVisibility(eventStatus) {
            const removeSelectedBtn = document.getElementById("removeSelectedBtn");
            const anyChecked = document.querySelectorAll(".userCheckboxx:checked").length > 0;
            removeSelectedBtn.style.display = anyChecked && eventStatus !== "Terminé" ? "inline-flex" : "none";
        }

        // Fonction pour attacher les événements aux cases
        function attachCheckboxEvents(eventStatus) {
            const selectAllCheckbox = document.getElementById("selectAllCheckbox");
            selectAllCheckbox.addEventListener("change", function () {
                const isChecked = this.checked;
                document.querySelectorAll(".userCheckboxx").forEach(checkbox => checkbox.checked = isChecked);
                updateRemoveButtonVisibility(eventStatus);
            });

            document.querySelectorAll(".userCheckboxx").forEach(checkbox => {
                checkbox.addEventListener("change", () => updateRemoveButtonVisibility(eventStatus));
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const eventEndDateStr = "<%= eventEndDate %>";
            const eventStatus = "<%= eventStatus %>";
            const eventId = "<%= eventId %>";

            // Appeler fetchUserInfo au chargement
            fetchUserInfo();

            const addUserBtn = document.getElementById("addUserBtn");
            const removeSelectedBtn = document.getElementById("removeSelectedBtn");

            // Bouton Retirer initialement masqué
            removeSelectedBtn.style.display = "none";

            // Attacher les événements aux cases au chargement initial
            attachCheckboxEvents(eventStatus);

            addUserBtn.addEventListener("click", function () {
                const addOptionsModal = new bootstrap.Modal(document.getElementById('addOptionsModal'));
                addOptionsModal.show();
            });

            removeSelectedBtn.addEventListener("click", function () {
                removeSelectedUsers();
            });

            document.getElementById("addUsersOptionBtn").addEventListener("click", function () {
                const addOptionsModal = bootstrap.Modal.getInstance(document.getElementById('addOptionsModal'));
                addOptionsModal.hide();
                const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
                addUserModal.show();
                fetchUsers();
            });

            document.getElementById("addOrgOptionBtn").addEventListener("click", function () {
                const addOptionsModal = bootstrap.Modal.getInstance(document.getElementById('addOptionsModal'));
                addOptionsModal.hide();
                const addOrgModal = new bootstrap.Modal(document.getElementById('addOrgModal'));
                addOrgModal.show();
                fetchOrganizations();
            });

            document.querySelectorAll('.user-row').forEach(row => {
                row.addEventListener('click', function (e) {
                    if (e.target.tagName !== 'INPUT') {
                        const userId = this.dataset.id;
                        const name = this.dataset.name;
                        const surname = this.dataset.surname;
                        const civility = this.dataset.civility;
                        const birthdate = this.dataset.birthdate;
                        const email = this.dataset.email;
                        const role = this.dataset.role;
                        const accessCode = this.dataset.accesscode;

                        document.getElementById('modalName').textContent = name;
                        document.getElementById('modalSurname').textContent = surname;
                        document.getElementById('modalCivility').textContent = civility;
                        document.getElementById('modalBirthdate').textContent = birthdate;
                        document.getElementById('modalEmail').textContent = email;
                        document.getElementById('modalRole').textContent = role;
                        document.getElementById('modalAccessCode').textContent = accessCode || 'Non généré';

                        const qrData = JSON.stringify({ userId, eventId: "<%= eventId %>", accessCode });
                        QRCode.toDataURL(qrData, function (err, url) {
                            if (err) console.error(err);
                            document.getElementById('modalQRCode').src = url;
                        });

                        const userDetailModal = new bootstrap.Modal(document.getElementById('userDetailModal'));
                        userDetailModal.show();
                    }
                });
            });

            document.getElementById("backToOrgModalBtn").addEventListener("click", function () {
                const orgUsersModal = bootstrap.Modal.getInstance(document.getElementById('orgUsersModal'));
                orgUsersModal.hide();
                const addOrgModal = new bootstrap.Modal(document.getElementById('addOrgModal'));
                addOrgModal.show();
            });

            loadEventUsers(eventId);
            checkEventStatus(eventId);
        });

        async function fetchUsers() {
            const userTableBody = document.getElementById("userTableBody");
            const totalUsersCount = document.getElementById("totalUsersCount");
            userTableBody.innerHTML = "";

            try {
                const response = await fetch("/api/getUsersWithRoles");
                if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                const users = await response.json();

                totalUsersCount.textContent = `Nombre total d'utilisateurs : ${users.length}`;

                if (users.length > 0) {
                    const addedUserIds = new Set();
                    users.forEach(user => {
                        if (!addedUserIds.has(user.id)) {
                            addedUserIds.add(user.id);
                            const row = `
                                <tr>
                                    <td><input type="checkbox" class="userCheckbox" data-id="${user.id}"></td>
                                    <td>${user.id}</td>
                                    <td>${user.name}</td>
                                    <td>${user.surname}</td>
                                    <td>${user.email}</td>
                                    <td>${user.role}</td>
                                </tr>`;
                            userTableBody.insertAdjacentHTML("beforeend", row);
                        }
                    });
                } else {
                    userTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Aucun participant trouvé.</td></tr>`;
                }
            } catch (error) {
                console.error("Erreur lors du chargement des participants :", error);
            }
        }

        async function fetchOrganizations() {
            const orgTableBody = document.getElementById("orgTableBody");
            orgTableBody.innerHTML = "";

            try {
                const response = await fetch("/api/getOrganizations");
                if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                const orgs = await response.json();

                if (orgs.length > 0) {
                    orgs.forEach(org => {
                        const row = `
                            <tr>
                                <td>${org.id}</td>
                                <td>${org.name}</td>
                                <td>${org.code}</td>
                                <td><button class="btn btn-custom-action view-org-users" data-org-id="${org.id}"><i class="fas fa-users"></i> Voir participants</button></td>
                            </tr>`;
                        orgTableBody.insertAdjacentHTML("beforeend", row);
                    });

                    document.querySelectorAll(".view-org-users").forEach(btn => {
                        btn.addEventListener("click", function () {
                            const orgId = this.getAttribute("data-org-id");
                            fetchOrgUsers(orgId);
                            const addOrgModal = bootstrap.Modal.getInstance(document.getElementById('addOrgModal'));
                            addOrgModal.hide();
                            const orgUsersModal = new bootstrap.Modal(document.getElementById('orgUsersModal'));
                            orgUsersModal.show();
                        });
                    });
                } else {
                    orgTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">Aucune organisation trouvée.</td></tr>`;
                }
            } catch (error) {
                console.error("Erreur lors du chargement des organisations :", error);
            }
        }

        async function fetchOrgUsers(orgId) {
            const orgUsersTableBody = document.getElementById("orgUsersTableBody");
            orgUsersTableBody.innerHTML = "";

            try {
                const response = await fetch(`/api/getUsersByOrg/${orgId}`);
                if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                const users = await response.json();

                if (users.length > 0) {
                    users.forEach(user => {
                        const row = `
                            <tr>
                                <td><input type="checkbox" class="orgUserCheckbox" data-id="${user.id}"></td>
                                <td>${user.id}</td>
                                <td>${user.name}</td>
                                <td>${user.surname}</td>
                                <td>${user.email || '-'}</td>
                                <td>${user.role || '-'}</td>
                            </tr>`;
                        orgUsersTableBody.insertAdjacentHTML("beforeend", row);
                    });
                } else {
                    orgUsersTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Aucun participant dans cette organisation.</td></tr>`;
                }
            } catch (error) {
                console.error("Erreur lors du chargement des participants de l'organisation :", error);
            }
        }

        document.getElementById("saveUsersBtn").addEventListener("click", async function () {
            const selectedCheckboxes = document.querySelectorAll(".userCheckbox:checked");
            const selectedUsers = Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute("data-id"));

            if (selectedUsers.length === 0) {
                Swal.fire({
                    icon: "warning",
                    title: "Aucun participant sélectionné",
                    text: "Veuillez sélectionner au moins un participant avant d'enregistrer."
                });
                return;
            }

            await addUsersToEvent(selectedUsers);
        });

        document.getElementById("addOrgUsersBtn").addEventListener("click", async function () {
            const selectedCheckboxes = document.querySelectorAll(".orgUserCheckbox:checked");
            const selectedUsers = Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute("data-id"));

            if (selectedUsers.length === 0) {
                Swal.fire({
                    icon: "warning",
                    title: "Aucun participant sélectionné",
                    text: "Veuillez sélectionner au moins un participant avant d'ajouter."
                });
                return;
            }

            await addUsersToEvent(selectedUsers);
            const orgUsersModal = bootstrap.Modal.getInstance(document.getElementById('orgUsersModal'));
            orgUsersModal.hide();
        });

        document.getElementById("saveOrgUsersBtn").addEventListener("click", async function () {
            const selectedUsers = Array.from(document.querySelectorAll(".orgUserCheckbox:checked")).map(cb => cb.getAttribute("data-id"));
            if (selectedUsers.length > 0) {
                await addUsersToEvent(selectedUsers);
            }
            const addOrgModal = bootstrap.Modal.getInstance(document.getElementById('addOrgModal'));
            addOrgModal.hide();
        });

        async function addUsersToEvent(selectedUsers) {
            try {
                const eventId = "<%= eventId %>";
                const response = await fetch("/api/addUsersToEvent", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ selectedUsers, eventId })
                });

                const result = await response.json();
                if (response.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "Succès",
                        text: "Les participants ont été ajoutés avec succès à l'événement."
                    });
                    const addUserModal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                    if (addUserModal) addUserModal.hide();
                    loadEventUsers(eventId);
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Erreur",
                        text: result.error || "Une erreur s'est produite."
                    });
                }
            } catch (error) {
                console.error("Erreur lors de la sauvegarde :", error);
                Swal.fire({
                    icon: "error",
                    title: "Erreur",
                    text: "Impossible d'enregistrer les participants pour le moment."
                });
            }
        }

        async function loadEventUsers(eventId) {
            const tableBody = document.querySelector("table tbody");
            const eventUsersCount = document.getElementById("eventUsersCount");
            tableBody.innerHTML = "";

            try {
                const response = await fetch(`/api/getUsersByEvent/${eventId}`);
                const users = await response.json();

                eventUsersCount.textContent = `Participants affichés : ${users.length}`;

                if (users.length > 0) {
                    users.forEach(user => {
                        const row = `
                            <tr data-id="${user.id}" data-name="${user.name}" data-surname="${user.surname}" data-civility="${user.civility || '-'}" data-birthdate="${user.birthdate || '-'}" data-email="${user.email || '-'}" data-role="${user.role || '-'}" data-accessCode="${user.accessCode || 'Non généré'}">
                                <td><input type="checkbox" class="userCheckboxx" data-id="${user.id}"></td>
                                <td>${user.id}</td>
                                <td>${user.name}</td>
                                <td>${user.surname}</td>
                                <td>${user.civility || '-'}</td>
                                <td>${user.birthdate || '-'}</td>
                                <td>${user.email || '-'}</td>
                                <td>${user.role || '-'}</td>
                                <td>${user.accessCode || 'Non généré'}</td>
                            </tr>`;
                        tableBody.insertAdjacentHTML("beforeend", row);
                    });
                } else {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">Aucun participant trouvé pour cet événement.</td></tr>`;
                }

                // Réattacher les événements après avoir chargé les utilisateurs
                attachCheckboxEvents("<%= eventStatus %>");
                updateRemoveButtonVisibility("<%= eventStatus %>");
            } catch (error) {
                console.error('Erreur lors du chargement des participants :', error);
                eventUsersCount.textContent = "Erreur lors du chargement du nombre de participants";
            }
        }

        function removeSelectedUsers() {
            let selectedUsers = [];
            document.querySelectorAll('.userCheckboxx:checked').forEach(function(checkbox) {
                selectedUsers.push(checkbox.getAttribute('data-id'));
            });

            if (selectedUsers.length > 0) {
                Swal.fire({
                    title: 'Voulez-vous vraiment retirer ces participants de l\'événement ?',
                    text: "Cette action ne peut pas être annulée.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, retirer',
                    cancelButtonText: 'Annuler',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        const eventId = "<%= eventId %>";
                        fetch('/api/removeUsersFromEvent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ selectedUsers, eventId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                selectedUsers.forEach(userId => {
                                    const row = document.querySelector(`[data-id="${userId}"]`);
                                    if (row) row.remove();
                                });
                                loadEventUsers(eventId);
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Succès',
                                    text: 'Les participants ont été retirés avec succès de l\'événement.'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Erreur',
                                    text: data.error || 'Une erreur est survenue.'
                                });
                            }
                        })
                        .catch(error => {
                            console.error("Erreur lors de la suppression :", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur',
                                text: 'Erreur lors de la communication avec le serveur.'
                            });
                        });
                    }
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Attention',
                    text: 'Aucun participant sélectionné.'
                });
            }
        }

        document.getElementById("searchInput").addEventListener("input", function () {
            const searchQuery = this.value.toLowerCase();
            const rows = document.querySelectorAll("table tbody tr");
            rows.forEach(row => {
                const name = row.querySelector("td:nth-child(3)").textContent.toLowerCase();
                const surname = row.querySelector("td:nth-child(4)").textContent.toLowerCase();
                if (name.includes(searchQuery) || surname.includes(searchQuery)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
            updateRemoveButtonVisibility("<%= eventStatus %>");
        });

        async function checkEventStatus(eventId) {
            try {
                const response = await fetch(`/api/getEventStatus/${eventId}`);
                const event = await response.json();

                const addUserBtn = document.getElementById("addUserBtn");
                const removeSelectedBtn = document.getElementById("removeSelectedBtn");

                if (event.status === "terminé") {
                    addUserBtn.style.display = "none";
                    removeSelectedBtn.style.display = "none";
                }
            } catch (error) {
                console.error("Erreur lors de la récupération du statut de l'événement :", error);
            }
        }

        document.querySelectorAll("th[data-column]").forEach(header => {
            header.addEventListener("click", function () {
                const column = this.getAttribute("data-column");
                let sortOrder = this.getAttribute("data-sort");
                sortOrder = sortOrder === "asc" ? "desc" : "asc";
                this.setAttribute("data-sort", sortOrder);

                document.querySelectorAll("th[data-column] .arrow").forEach(arrow => arrow.textContent = "");
                let arrow = this.querySelector(".arrow");
                if (!arrow) {
                    arrow = document.createElement("span");
                    arrow.classList.add("arrow");
                    this.appendChild(arrow);
                }
                arrow.textContent = sortOrder === "asc" ? "🔼" : "🔽";

                const rows = Array.from(document.querySelectorAll("tbody tr"));
                rows.sort((a, b) => {
                    const cellA = a.querySelector(`td:nth-child(${this.cellIndex + 1})`).textContent.trim();
                    const cellB = b.querySelector(`td:nth-child(${this.cellIndex + 1})`).textContent.trim();
                    if (sortOrder === "asc") {
                        return cellA.localeCompare(cellB, undefined, { numeric: true });
                    } else {
                        return cellB.localeCompare(cellA, undefined, { numeric: true });
                    }
                });

                const tableBody = document.querySelector("tbody");
                tableBody.innerHTML = "";
                rows.forEach(row => tableBody.appendChild(row));
                attachCheckboxEvents("<%= eventStatus %>");
                updateRemoveButtonVisibility("<%= eventStatus %>");
            });
        });

        document.getElementById("selectAll").addEventListener("change", function (event) {
            const isChecked = event.target.checked;
            document.querySelectorAll(".userCheckbox").forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });

        document.getElementById("selectAllOrgUsers").addEventListener("change", function (event) {
            const isChecked = event.target.checked;
            document.querySelectorAll(".orgUserCheckbox").forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });
    </script>
</body>
</html>