<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport de l'Événement</title>
    <style>
        @page {
            size: A4;
            margin: 10mm 10mm 15mm 10mm;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: white; /* Page entièrement blanche */
            color: #333;
            font-size: 12px;
        }
        .header {
            text-align: center;
            padding: 30px; /* Ajustement pour un espacement interne similaire à la photo */
            background-color: #B2D8D8; /* Vert clair comme dans la deuxième photo */
            color: #333;
            border: 1px solid #0f766e; /* Bordure noire fine comme dans la première photo */
            border-radius: 8px; /* Coins légèrement arrondis */
            margin: 20px 30px; /* Marge externe pour centrer et espacer */
        }
        .content {
            margin: 10px 20px; /* Marges réduites pour plus d'espace */
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        table th {
            background-color: #B2D8D8;
            color: #333;
        }
        img.chart-size {
            max-width: 60%; /* Taille amplifiée */
            height: auto;
            display: block;
            margin: 20px auto;
        }
        img.logo-size {
            max-width: 150px;
            height: auto;
            margin: 20px auto;
            display: block;
        }
        img.footer-img {
            width: 100%;
            max-width: 400px;
            height: auto;
        }
        .footer {
            position: fixed;
            bottom: 5mm;
            left: 0;
            right: 0;
            text-align: center;
            width: 100%;
            border-top: 1px solid #ccc; /* Trait gris clair en bas de chaque page */
            padding-top: 5px;
        }
        .chart-container {
            text-align: center;
            margin: 20px 0; /* Espacement réduit pour équilibre visuel */
        }
        .chart-container h3 {
            margin-bottom: 10px;
        }
        h2, h3 {
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
        }
        .new-page {
            page-break-before: always;
        }
        .page {
            page-break-after: always;
        }
        .page:last-child {
            page-break-after: auto;
        }
    </style>
</head>
<body>
    <!-- Pied de page sur chaque page avec un trait gris clair -->
    <div class="footer">
        <% if (footerImageBase64) { %>
            <img src="data:image/png;base64,<%= footerImageBase64 %>" alt="Footer" class="footer-img">
        <% } else { %>
            <p>Pied de page non disponible</p>
        <% } %>
    </div>

    <!-- Page 1 : Liste des Participants -->
    <div class="header">
        <% if (logoBase64) { %>
            <img src="data:image/png;base64,<%= logoBase64 %>" alt="Logo" class="logo-size">
        <% } else { %>
            <p>Logo non disponible</p>
        <% } %>
        <h1>Rapport de l'Événement</h1>
        <p><strong>Nom de l'Événement :</strong> <%= eventName || 'Non spécifié' %></p>
        <p><strong>Dates :</strong> <%= eventStartDate || 'Non spécifiée' %> - <%= eventEndDate || 'Non spécifiée' %></p>
        <p><strong>Organisateurs :</strong> <%= organizers || 'Non spécifié' %></p>
    </div>

    <div class="content page" id="listeParticipants">
        <h2>Liste des Participants</h2>
        <% if (users && users.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Présence</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach(user => { %>
                        <tr>
                            <td><%= user.name || 'Non spécifié' %></td>
                            <td><%= user.surname || 'Non spécifié' %></td>
                            <td><%= user.email || 'Non spécifié' %></td>
                            <td><%= user.role || 'Non spécifié' %></td>
                            <td><%= (event && event.presence && event.presence[user.id] === true) ? 'Présent' : 'Absent' %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p>Aucun participant trouvé.</p>
        <% } %>
    </div>

    <!-- Page 2 : Statistiques Globales -->
    <div class="content page" id="Statistiquesglobales">
        <h2>Statistiques Globales</h2>
        <% if (totalStats && stats && participantRoles && participantRoles.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Rôle</th>
                        <th>Total</th>
                        <th>Présents</th>
                        <th>Absents</th>
                    </tr>
                </thead>
                <tbody>
                    <% participantRoles.forEach(role => { 
                        const roleKey = role.toLowerCase();
                        const totalKey = `total${role.charAt(0).toUpperCase() + role.slice(1)}s`;
                    %>
                        <tr>
                            <td><%= role %></td>
                            <td><%= totalStats[totalKey] || 0 %></td>
                            <td><%= stats[roleKey] ? stats[roleKey].present : 0 %></td>
                            <td><%= stats[roleKey] ? stats[roleKey].absent : 0 %></td>
                        </tr>
                    <% }); %>
                    <tr>
                        <td><strong>Total</strong></td>
                        <td><strong><%= participantRoles.reduce((sum, role) => sum + (totalStats[`total${role.charAt(0).toUpperCase() + role.slice(1)}s`] || 0), 0) %></strong></td>
                        <td><strong><%= totalStats.totalPrésents || 0 %></strong></td>
                        <td><strong><%= totalStats.totalAbsents || 0 %></strong></td>
                    </tr>
                </tbody>
            </table>
        <% } else { %>
            <p>Aucune statistique disponible.</p>
        <% } %>
    </div>

    <!-- Graphiques des Présences (2 graphiques par page) -->
    <div class="content page" id="Statistiquesgraphiques">
        <h2 style="text-align: center; margin-bottom: 30px;">Graphiques des Présences</h2>
        <% 
        const presenceCharts = [...participantRoles.map(role => ({ role, chart: chartBase64[role.toLowerCase()] })), 
                               { role: 'Total Présence/Absence', chart: totalPresenceChartBase64 }];
        let currentGroup = [];
        presenceCharts.forEach((item, index) => { 
            currentGroup.push(item);
            if (currentGroup.length === 2 || index === presenceCharts.length - 1) { %>
                <% currentGroup.forEach(item => { %>
                    <div class="chart-container">
                        <h3><%= item.role %></h3>
                        <img src="data:image/png;base64,<%= item.chart || '' %>" 
                             alt="<%= item.role %> Graphique" 
                             class="chart-size">
                    </div>
                <% }); %>
                <% if (index < presenceCharts.length - 1) { %>
                    <div style="page-break-after: always;"></div>
                <% } %>
                <% currentGroup = []; %>
            <% } %>
        <% }); %>
    </div>

    <!-- Page X : Tableau des Votes -->
    <div class="content page" id="TableauVotes">
        <h2>Tableau des Votes</h2>
        <% if (voteTable && voteTable.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Choix de Vote</th>
                    </tr>
                </thead>
                <tbody>
                    <% voteTable.forEach(userVote => { %>
                        <tr>
                            <td><%= userVote.name || 'Inconnu' %></td>
                            <td><%= userVote.surname || 'Inconnu' %></td>
                            <td><%= userVote.email || 'Inconnu' %></td>
                            <td><%= userVote.role || 'Inconnu' %></td>
                            <td><%= userVote.voteChoice || 'Non voté' %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p>Aucun vote enregistré.</p>
        <% } %>
    </div>

    <!-- Graphiques des Votes (2 graphiques par page) -->
    <div class="content page" id="GraphiqueVotesParProfil">
        <h2 style="text-align: center; margin-bottom: 30px;">Graphiques des Votes</h2>
        <% 
        const voteCharts = [...voteEligibleRoles.map(role => ({ role, chart: voteChartByRoleBase64[role.toLowerCase()] })), 
                           { role: 'Résultat Total des Votes', chart: voteChartBase64 }];
        currentGroup = [];
        voteCharts.forEach((item, index) => { 
            currentGroup.push(item);
            if (currentGroup.length === 2 || index === voteCharts.length - 1) { %>
                <% currentGroup.forEach(item => { %>
                    <div class="chart-container">
                        <h3><%= item.role %></h3>
                        <img src="data:image/png;base64,<%= item.chart || '' %>" 
                             alt="<%= item.role %> Votes Graphique" 
                             class="chart-size">
                    </div>
                <% }); %>
                <% if (index < voteCharts.length - 1) { %>
                    <div style="page-break-after: always;"></div>
                <% } %>
                <% currentGroup = []; %>
            <% } %>
        <% }); %>
    </div>
</body>
</html>